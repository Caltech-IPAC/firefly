<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>api/ApiHighlevelBuild.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="module-lowLevelApi.CysConverter.CysConverter.html">CysConverter</a></li></ul><h3>Modules</h3><ul><li><a href="module-highLevelApi.html">highLevelApi</a><ul class='methods'><li data-type='method'><a href="module-highLevelApi.html#~addXYPlot">addXYPlot</a></li><li data-type='method'><a href="module-highLevelApi.html#~getViewer">getViewer</a></li><li data-type='method'><a href="module-highLevelApi.html#~setGlobalImageDef">setGlobalImageDef</a></li><li data-type='method'><a href="module-highLevelApi.html#~showCoverage">showCoverage</a></li><li data-type='method'><a href="module-highLevelApi.html#~showImage">showImage</a></li><li data-type='method'><a href="module-highLevelApi.html#~showImageFileOrUrl">showImageFileOrUrl</a></li><li data-type='method'><a href="module-highLevelApi.html#~showTable">showTable</a></li><li data-type='method'><a href="module-highLevelApi.html#~showXYPlot">showXYPlot</a></li></ul></li><li><a href="module-lowLevelApi.html">lowLevelApi</a><ul class='methods'><li data-type='method'><a href="module-lowLevelApi.html#.addActionListener">addActionListener</a></li><li data-type='method'><a href="module-lowLevelApi.html#.dispatchAddRegionEntry">dispatchAddRegionEntry</a></li><li data-type='method'><a href="module-lowLevelApi.html#.dispatchCreateRegionLayer">dispatchCreateRegionLayer</a></li><li data-type='method'><a href="module-lowLevelApi.html#.dispatchDeleteRegionLayer">dispatchDeleteRegionLayer</a></li><li data-type='method'><a href="module-lowLevelApi.html#.dispatchLoadPlotData">dispatchLoadPlotData</a></li><li data-type='method'><a href="module-lowLevelApi.html#.dispatchRemoveRegionEntry">dispatchRemoveRegionEntry</a></li><li data-type='method'><a href="module-lowLevelApi.html#~getImageCoords">getImageCoords</a></li><li data-type='method'><a href="module-lowLevelApi.html#.getPrimePlot">getPrimePlot</a></li><li data-type='method'><a href="module-lowLevelApi.html#~getScreenCoords">getScreenCoords</a></li><li data-type='method'><a href="module-lowLevelApi.html#~getViewPortCoords">getViewPortCoords</a></li><li data-type='method'><a href="module-lowLevelApi.html#~getWorldCoords">getWorldCoords</a></li><li data-type='method'><a href="module-lowLevelApi.html#~getWorldPtRepresentation">getWorldPtRepresentation</a></li><li data-type='method'><a href="module-lowLevelApi.html#.initAutoReadout">initAutoReadout</a></li><li data-type='method'><a href="module-lowLevelApi.html#.makeFileRequest">makeFileRequest</a></li><li data-type='method'><a href="module-lowLevelApi.html#.makeIrsaCatalogRequest">makeIrsaCatalogRequest</a></li><li data-type='method'><a href="module-lowLevelApi.html#.makeTblRequest">makeTblRequest</a></li><li data-type='method'><a href="module-lowLevelApi.html#~renderDOM">renderDOM</a></li><li data-type='method'><a href="module-lowLevelApi.html#.serializeSimpleRangeValues">serializeSimpleRangeValues</a></li><li data-type='method'><a href="module-lowLevelApi.html#~unrenderDOM">unrenderDOM</a></li></ul></li></ul><h3>Namespaces</h3><ul><li><a href="module-lowLevelApi-firefly.html">firefly</a></li><li><a href="module-lowLevelApi-firefly_action.html">firefly/action</a></li><li><a href="module-lowLevelApi-firefly_ui.html">firefly/ui</a></li><li><a href="module-lowLevelApi-firefly_util.html">firefly/util</a></li></ul><h3>Tutorials</h3><ul><li><a href="tutorial-firefly-api-code-examples.html">firefly-api-code-examples</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">api/ApiHighlevelBuild.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/*
 * License information at https://github.com/Caltech-IPAC/firefly/blob/master/License.txt
 */

//===================================================================================
//-----------------------------------------------------------------------------------
// Build the firefly high level api
// This file should have has no imports.  It should be build the high level api completely from the lowlevel.
// There are two reasons for this.
//   1. It will be an example of how to use the lowlevel api
//   2. We want to make sure the the lowlevel api is only built with the high level.  That
//      way we know that the lowlevel is complete.
//-----------------------------------------------------------------------------------
//===================================================================================
/*
 * @desc using the lowerLeverApi to build the highLevelApi. The high levelApi is referred directly by firefly.xxx, where xxx
 * is the memeber's name
 * @param llApi the lowlevel api
 * @return {Object}
 */
/**
 * @desc build highLevelApi using the lowLevelApi as an input
 * @module highLevelApi
 */
export function buildHighLevelApi(llApi) {
    const current= build(llApi);
    const deprecated= buildDeprecated(llApi);

    return Object.assign({}, deprecated, current);
}


var globalImageViewDefParams= {};

/*
 * Build the deprecated API
 * @param llApi
 * @return {Object}
 */
function build(llApi) {

    const commonPart= buildCommon(llApi);
    const imagePart= buildImagePart(llApi);
    const chartPart= buildChartPart(llApi);
    const tablePart= buildTablePart(llApi);
    return Object.assign({}, commonPart, imagePart,chartPart,tablePart);
}

/*----------------------------&lt; TABLE PART ----------------------------*/

var divToGrp = (() => {
    // workaround to support mapping first targetDiv to 'main'
    var main;
    return (div) => {
        if (!main) main = div;
        return div === main ? 'main' : div;
    };
})();

function oldApi(llApi, params, options) {
    const {getBoolean} = llApi.util;
    const {makeFileRequest} = llApi.util.table;

    const oldOpts = params.tableOptions &amp;&amp; params.tableOptions.split(',').reduce((rval, s) => {
                        const kval = s &amp;&amp; s.trim().split('=');
                        rval[kval[0]] = kval[1];
                        return rval;
                    }, {});      // convert 'key=value' array into {key: value}.
    options.showFilters = getBoolean(oldOpts, 'show-filter');
    options.showTitle = getBoolean(oldOpts, 'show-title');
    options.showToolbar = getBoolean(oldOpts, 'show-toolbar');
    options.showOptionButton = getBoolean(oldOpts, 'show-options');
    options.showPaging = getBoolean(oldOpts, 'show-paging');
    options.showSave = getBoolean(oldOpts, 'show-save');
    options.showUnits = getBoolean(oldOpts, 'show-units');
    // options.?? = getBoolean(oldOpts, 'show-popout');
    // options.?? = getBoolean(oldOpts, 'show-table-view');

    var {Title, source, alt_source, type, filters, sortInfo, pageSize, startIdx, fixedLength, expandable, rowHeight} = params;
    var request = makeFileRequest(Title, source, alt_source, {filters, sortInfo, pageSize, startIdx});
    options.selectable = type === 'selectable';
    options.help_id = 'tables';
    options.expandable = !!expandable;
    options.rowHeight = rowHeight;
    return request;
}

function doShowTable(llApi, targetDiv, request, options={}) {
    const {dispatchTableSearch}= llApi.action;
    const {renderDOM}= llApi.util;
    const {TablesContainer}= llApi.ui;
    var contProps = {};

    if ((typeof targetDiv).match(/string|HTMLDivElement/) === null) {
        // old api.. need to setup request and options before continue.
        const params = targetDiv;
        targetDiv = request;
        request = oldApi(llApi, params, options);
    }

    options.tbl_group = options.tbl_group || divToGrp(targetDiv);
    contProps.tbl_group = options.tbl_group;

    Object.keys(options).forEach( (k) => {
        if (options[k] === undefined) {
            Reflect.deleteProperty(options, k);
        }
    });

    dispatchTableSearch(request, options);
    renderDOM(targetDiv, TablesContainer, contProps);
}


function buildTablePart(llApi) {
    const {dispatchTableFetch}= llApi.action;

    /*
     * @typedef {object} TblOptions - table options
     * @prop {string}  tbl_group    the group this table belongs to.  Defaults to 'main'.
     * @prop {boolean} removable    true if this table can be removed from view.  Defaults to true.
     * @prop {boolean} showUnits    defaults to false
     * @prop {boolean} showFilters  defaults to false
     * @prop {boolean} selectable   defaults to true
     * @prop {boolean} expandable   defaults to true
     * @prop {boolean} showToolbar  defaults to true
     * @prop {boolean} border       defaults to true
     */

    /**
     *@function showTable
     * @param {string|HTMLDivElement} targetDiv to put the table in.
     * @param {Object} request         request object created from
     * @param {TblOptions} options     table options.
     * @memeberof firefly
     * @example fierfly.showTable
     */
    const showTable= (targetDiv, request, options)  => doShowTable(llApi, targetDiv, request, options);

    return {showTable};
}

/*---------------------------- TABLE PART >----------------------------*/


function buildChartPart(llApi) {

    /*
     * @typedef {object} XYPlotOptions  xy plot options
     * @prop {string}  source       location of the ipac table, url or file path; ignored when XY plot view is added to table
     * @prop {string}  QUERY_ID     required when XY plot view is added to the table. It connects this XY Plot to the table and should be the same string that you specified as the div parameter when you created the table.
     * @prop {string}  chartTitle   title of the chart
     * @prop {string}  xCol         column or expression to use for x values, can contain multiple column names ex. log(col) or (col1-col2)/col3
     * @prop {string}  yCol         column or expression to use for y values, can contain multiple column names ex. sin(col) or (col1-col2)/col3
     * @prop {number}  xyRatio      aspect ratio (must be between 1 and 10)
     * @prop {string}  stretch      fit or fill
     * @prop {string}  xLabel       label to use with x axis
     * @prop {string}  yLabel       label to use with y axis
     * @prop {string}  xUnit        unit for x axis
     * @prop {string}  yUnit        unit for y axis
     * @prop {string}  xOptions     comma separated list of x axis options: grid,flip,log
     * @prop {string}  yOptions     comma separated list of y axis options: grid,flip,log
     */

    /* LZ leave this line as a comment here since it appears twice when it is added to the jsdoc
     * @description The general plotting function to plot an XY Plot.
     * */
    /**
     * @param {string|HTMLDivElement} targetDiv to put the chart in.
     * @param {XYPlotOptions} parameters the request object literal with the chart parameters
     * @namespace firefly
     * @function showXYPlot
     * @example firefly.showXYPlot
     */
    const showXYPlot= (targetDiv, parameters)  => doShowXYPlot(llApi, targetDiv, parameters);
    /**
     *
     * @param {string|HTMLDivElement} targetDiv to put the chart in.
     * @param {XYPlotOptions} parameters the request object literal with the chart parameters
     * @namespace firefly
     * @function addXYPlot
     *
     * @example firefly.addXYPlot
     */
    /*  It appears twice when it is added in the above jsdoc block
     * @description Add XY Plot view of an existing table.
     */
    const addXYPlot= (targetDiv, parameters) => doShowXYPlot(llApi, targetDiv, parameters);

    return {showXYPlot, addXYPlot};
}

function buildCommon(llApi) {
    /*
     * Sets the root path for any relative URL. If this method has not been called then relative URLs use the page's root.
     * @param {String} rootUrlPath
     *
     */
    //*
    const setRootPath= (rootUrlPath) => llApi.action.dispatchRootUrlPath(rootUrlPath);

    return {setRootPath};
}

function buildImagePart(llApi) {


    const {RequestType}= llApi.util.image;

    /* LZ leave the description here since it always appears twice when it adds to the jsdoc
     * @description The general plotting function to plot a FITS image.
     */
     /**
     * @param {String|div} targetDiv to put the image in.
     * @param {Object} request the request object literal with the plotting parameters
     * @function showImage
     * @example firefly.showImage
     *
     */
    const showImage= (targetDiv, request)  => showImageInMultiViewer(llApi, targetDiv, request);


    /*
     * a convenience plotting function to plot a file on the server or a url.  If first looks for the file then
     * the url is the fallback
    */
    /**
     *
     * @param {String|div} targetDiv to put the image in.
     * @param {String} file file on server
     * @param {String} url url reference to a fits file
     * @function showImageFileOrUrl
     * @example firefly.showImageFileOrUrl
     */

    const showImageFileOrUrl= (targetDiv, file,url) =>
              showImageInMultiViewer(llApi, targetDiv,
                                           {'File' : file,
                                            'URL' : url,
                                            'Type' : RequestType.TRY_FILE_THEN_URL
                                           });

    /*
     * set global fallback params for every image plotting call*/
    /**
     * @param {Object} params a object literal such as any image plot or showImage uses
     * @namespace firefly
     * @Function setGlobalImageDef
     * @example firefly.setGlobalImageDef
     */
    const setGlobalImageDef= (params) => globalImageViewDefParams= params;


    /**
     *
     * @param {div} targetDiv to put the coverage in.
     * @param options  an object literal containing a list of the coverage options
     * @namespace firefly
     * @function showCoverage
     * @example firefly.showCoverage
     */
    const showCoverage= (div,options) => initCoverage(llApi,div,options);

    return {showImage, showImageFileOrUrl, setGlobalImageDef, showCoverage};
}

/*
 * Build the deprecated API
 * @param llApi
 * @return {Object}
 * @Deprecated
 */
function buildDeprecated(llApi) {

    const dApi= {};
    const {RequestType}= llApi.util.image;

    dApi.makeImageViewer= (plotId) => {
        llApi.util.debug('makeImageViewer is deprecated, use firefly.showImage() instead');
        highlevelImageInit(llApi);
        const plotSimple= makePlotSimple(llApi,plotId);
        return {
            defP: {},
            setDefaultParams(params) {
                this.defP= params;
            },

            plot(request) {
                plotSimple(Object.assign({},this.defP, request));
            },

            plotFile(file) {
                plotSimple(Object.assign({},this.defP,{'File' : file}));
            },

            plotURL(url) {
                plotSimple(Object.assign({},this.defP,{'URL' : url}));
            },

            plotFileOrURL(file,url) {
                plotSimple(Object.assign({},this.defP,
                              {'File' : file,
                               'URL' : url,
                               'Type' : RequestType.TRY_FILE_THEN_URL
                               }));
            }
        };
    };
    dApi.setGlobalDefaultParams= (params) => globalImageViewDefParams= params;


    //!!!!!!! Add more Deprecated Api for table, histogram, xyplot here


    return dApi;
}




//================================================================
//---------- Private Image functions
//================================================================

function makePlotSimple(llApi, plotId) {
    return (request) => {
        llApi.util.renderDOM(plotId, llApi.ui.ImageViewer, {plotId});
        llApi.action.dispatchPlotImage({plotId, wpRequest:Object.assign({}, globalImageViewDefParams,request)});
    };
}

function showImageInMultiViewer(llApi, targetDiv, request) {
    const {dispatchPlotImage, dispatchAddViewer, dispatchAddImages}= llApi.action;
    const {findInvalidWPRKeys,confirmPlotRequest}= llApi.util.image;
    const {renderDOM,debug}= llApi.util;
    const {MultiImageViewer, MultiViewStandardToolbar}= llApi.ui;

    highlevelImageInit(llApi);
    const testR= Array.isArray(request) ? request : [request];
    testR.forEach( (r) => {
        const badList= findInvalidWPRKeys(r);
        if (badList.length) debug(`plot request has the following bad keys: ${badList}`);
    });
    request= confirmPlotRequest(request,globalImageViewDefParams,targetDiv,makePlotId);

    const plotId= !Array.isArray(request) ? request.plotId : request.find( (r) => r.plotId).plotId;
    dispatchAddViewer(targetDiv,'create_replace');
    dispatchPlotImage({plotId, wpRequest:request, viewerId:targetDiv});
    renderDOM(targetDiv, MultiImageViewer,
        {viewerId:targetDiv, canReceiveNewPlots:'create_replace', Toolbar:MultiViewStandardToolbar });

}

function initCoverage(llApi, targetDiv,options= {}) {
    const {MultiImageViewer, MultiViewStandardToolbar}= llApi.ui;
    const {dispatchAddSaga}= llApi.action;
    const {renderDOM,debug}= llApi.util;
    const {watchImageMetaData,watchCoverage}= llApi.util.image;
    highlevelImageInit(llApi);


    renderDOM(targetDiv, MultiImageViewer,
        {viewerId:targetDiv, canReceiveNewPlots:'replace_only', canDelete:false, Toolbar:MultiViewStandardToolbar });
    dispatchAddSaga(watchCoverage, {viewerId:targetDiv, options});
}



var imageInit= false;
function highlevelImageInit(llApi) {
    if (!imageInit) {
        llApi.util.image.dispatchApiToolsView(true);
        llApi.util.image.initAutoReadout();
        imageInit= true;
    }
}


var plotCnt= 0;

function makePlotId() {
    plotCnt++;
    return 'apiPlot-'+plotCnt;
}

//================================================================
//---------- Private Table functions
//================================================================




//================================================================
//---------- Private XYPlot or Histogram functions
//================================================================
/*
 *
 * @param llApi
 * @param targetDiv
 * @param params
 */
function doShowXYPlot(llApi, targetDiv, params={}) {
    const {dispatchTableFetch}= llApi.action;
    const {TBL_RESULTS_ACTIVE} = llApi.action.type;
    const {renderDOM} = llApi.util;
    const {makeFileRequest, getActiveTableId} = llApi.util.table;
    const {uniqueChartId, loadPlotDataForTbl} = llApi.util.chart;
    const {ChartsTableViewPanel}= llApi.ui;
    const {addActionListener} = llApi.util;

    if ((typeof targetDiv).match(/string|HTMLDivElement/) === null) {
        // old api.. need to change targetDiv and params
        const oldApiParams = targetDiv;
        targetDiv = params;
        params = oldApiParams;
    }

    const {xCol, yCol, xyRatio, stretch, xLabel, yLabel, xUnit, yUnit, xOptions, yOptions} = params;
    const xyPlotParams = xCol &amp;&amp; yCol ?
    {
        xyRatio,
        stretch,
        x : { columnOrExpr : xCol, label : xLabel, unit : xUnit, options : xOptions},
        y : { columnOrExpr : yCol, label : yLabel, unit : yUnit, options : yOptions}
    } : undefined;

    // it is not quite clear how to handle situation when there are multiple tables in a group
    // for now we are connecting to the currently active table in the group
    const tblGroup = params.QUERY_ID || params.tbl_group;
    var tblId = params.tbl_id;
    // standalone plot, not connected to an existing table
    if (!tblGroup &amp;&amp; !tblId) {
        const searchRequest = makeFileRequest(
            params.chartTitle||'', // title
            params.source,  // source
            null,  // alt_source
            {
                pageSize: 0 // options
            }
        );
        tblId = searchRequest.tbl_id;
        dispatchTableFetch(searchRequest);
    }

    const chartId = uniqueChartId(tblId||tblGroup);

    if (tblGroup) {
        tblId = getActiveTableId(tblGroup);
        addActionListener(TBL_RESULTS_ACTIVE, () => {
            const new_tblId = getActiveTableId(tblGroup);
            if (new_tblId !== tblId) {
                tblId = new_tblId;
                loadPlotDataForTbl(tblId, chartId, xyPlotParams);
            }
        });
    }
    loadPlotDataForTbl(tblId, chartId, xyPlotParams);

    renderDOM(targetDiv, ChartsTableViewPanel,
        {
            key: `${targetDiv}-xyplot`,
            tblId,
            chartId,
            closeable: false,
            expandedMode: false,
            chartType: 'scatter',
            deletable: false
        }
    );
}
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.0</a> on Fri Aug 12 2016 09:34:57 GMT-0700 (PDT) using the Minami theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
