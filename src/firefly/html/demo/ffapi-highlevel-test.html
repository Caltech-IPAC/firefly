<!doctype html>

<!--
  ~ License information at https://github.com/Caltech-IPAC/firefly/blob/master/License.txt
  -->

<html>

<head>
    <meta http-equiv="Cache-Control" content="no-cache">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>Demo of Firefly Tools</title>
</head>

<body>


<div style="width: 500px; padding: 50px 0 0 20px;">
    <br>
    This page demos new api
    <br>
</div>

<div>
    <!--<a href='javascript:firefly.getViewer("testChannel").showImage({url:"http://web.ipac.caltech.edu/staff/roby/demo/wise-m51-band2.fits"})'>test open</a>-->
    <a href='javascript:firefly.getViewer().plotURL("http://web.ipac.caltech.edu/staff/roby/demo/wise-m51-band2.fits")'>test open</a>
    <a href="javascript:plotRemote()">test again</a>
    <a href="javascript:firefly.getViewer().showImage(window.threeC)">3 C</a>
    <a href="javascript:firefly.action.dispatchZoom({plotId: 'xxq',userZoomType:'UP' ,dispatcher:window.ffViewer.dispatch})">up</a>
    <a href="javascript:firefly.action.dispatchZoom({plotId: 'xxq',userZoomType:'DOWN' ,dispatcher:window.ffViewer.dispatch})">down</a>
</div>
<div>
    <div id="imageViewHere" style="display: inline-block; width: 550px; height: 550px; margin: 10px;"></div>
    <div id="coverageHere" style="display: inline-block; width: 400px; height: 400px; margin: 10px;"></div>
</div>
<div>Tables from API calls:
    <a href='javascript:firefly.getViewer().showTable(tblReq3)'>Open a table</a>
    <a href='javascript:firefly.getViewer().showTable(tblReq1)'>Open allwise</a>
    <a href='javascript:tblReq1.sortInfo="ASC,ra"; firefly.getViewer().fetchTable(tblReq1)'>Sort allwise by ra</a>
</div>
<div>
    <div id="tables-2" style="display: inline-block; width: 550px; height: 300px; margin: 10px; background-color: white"></div>
    <div id="tables-1" style="display: inline-block; width: 550px; height: 300px; margin: 10px; background-color: white; position: absolute"></div>
</div>
<div id="xyPlot1" style="display: inline-block; width: 550px; height: 300px; margin: 10px; background-color: white"></div>
<div id="xyPlot2" style="display: inline-block; width: 550px; height: 300px; margin: 10px; background-color: white; position: absolute"></div>
<div>Tables from deprecated API calls:</div>
<div>
    <div id="oldSelectable" style="display: inline-block; width: 550px; height: 300px; margin: 10px; background-color: white"></div>
    <div id="oldBasic" style="display: inline-block; width: 550px; height: 300px; margin: 10px; background-color: white; position: absolute"></div>
</div>
<div>Deprecated API plot:</div>
<div>
    <div id="oldXyPlot1" style="display: inline-block; width: 550px; height: 300px; margin: 10px; background-color: white"></div>
</div>
<div id="old1" style="width: 300px; height: 300px; margin: 10px;"></div>
<div id="old2" style="width: 300px; height: 300px; margin: 10px;"></div>

<div>
    <div style="display: flex; width:820px">
        <p style="color:blue; margin:3px">Region</p> <p style="color:blue; margin:3px"> Test: </p>
        <p style="margin-top:3px">please enter a region ID or select a region ID first, then click the region operation.
            If there is no region ID entered, the hint shown in the text field is used for "Create Region Layer". </p>
    </div>

    <a href='javascript:createRegionLayer()'>Create Region Layer</a>
    <input type='text' placeholder='' list='regionCreated' id='createRegionId' name='createRegionLayer' onChange='updateDatalist()'>
    <datalist id='regionCreated'>
    </datalist>
    <a href='javascript:deleteRegionLayer()'>Delete Region Layer</a>
    <select id='regionList_delete'><option selected disabled>Region Layer:</option></select>
    <div>
        <textarea id="regionLayerContent" style="width: 800px; height: 300px; margin: 10px;"> </textarea>
    </div>
</div>
<div>
    <a href='javascript:addRegionEntry()'>Add Region Entry </a>
    <select id='regionEntry_add'><option selected disabled>Regiion Layers:</option></select>
    <a href='javascript:removeRegionEntry()'>Remove Region Entry</a>
    <select id='regionEntry_remove'><option selected disabled>Regiion Layers:</option></select>
    <div>
        <textarea id="moreRegionContent" style="width: 800px; height: 300px; margin: 10px;"> </textarea>
    </div>
</div>


<script type="text/javascript">
    {
        onFireflyLoaded= function(firefly) {

            window.ffViewer= firefly.getViewer();

            firefly.setGlobalImageDef({
                ZoomType  : 'TO_WIDTH'
            } );

            firefly.debug= true;

            var util= firefly.util;
            var ui= firefly.ui;
            // ----------------- to use minimal readout, do the following
            //  util.image.initAutoReadout(ui.DefaultApiReadout,
            //         {MouseReadoutComponent:ui.PopupMouseReadoutMinimal, showThumb:false,showMag:false});
            // -----------------

            var req= {
                plotId: 'xxq',
                Type      : 'SERVICE',
//                plotGroupId : 'myGroup',
                Service   : 'TWOMASS',
                Title     : '2mass from service',
                GridOn     : true,
//                GridOn     : 'TRUE_LABELS_FALSE',
                SurveyKey  : 'k',
                WorldPt    : '10.68479;41.26906;EQ_J2000',
                SizeInDeg  : '.12',
                AllowImageSelection : true
            };

            var req2= {
                Type      : 'SERVICE',
//                plotGroupId : 'myGroup',
                Service  : 'WISE',
                Title     : 'Wise',
                GridOn     : true,
//                GridOn     : 'TRUE_LABELS_FALSE',
                SurveyKey  : 'Atlas',
                bad1  : 'hello',
                bad2  : 'bye',
                bad3  : 'again',
                SurveyKeyBand  : '2',
                WorldPt    : '10.68479;41.26906;EQ_J2000',
                SizeInDeg  : '.12',
                RangeValues : firefly.util.image.RangeValues.serializeSimple('Sigma',-2,8,'Linear'),
                AllowImageSelection : true };



            window.threeC= [
                {
                    type      : 'SERVICE',
//                    plotGroupId : 'myGroup',
                    Service   : 'TWOMASS',
                    Title     : '3 color',
                    SurveyKey  : 'j',
                    WorldPt    : '10.68479;41.26906;EQ_J2000',
                    SizeInDeg  : '.12'
                },
                {
                    Type      : 'SERVICE',
//                    PLOTgroupId : 'myGroup',
                    Service   : 'TWOMASS',
                    Title     : '3 color',
                    SurveyKey  : 'h',
                    WorldPt    : '10.68479;41.26906;EQ_J2000',
                    SizeInDeg  : '.12'
                },
                {
                    Type      : 'SERVICE',
//                    plotGroupId : 'myGroup',
                    Service   : 'TWOMASS',
                    title     : '3 color',
                    SurveyKey  : 'k',
                    WorldPt    : '10.68479;41.26906;EQ_J2000',
                    moreBadKeys : 'qqq',
                    SizeInDeg  : '.12'
                }
            ];


            firefly.showImage('imageViewHere', req);
            firefly.showImage('imageViewHere', req2);
            firefly.showImage('imageViewHere', window.threeC);
            firefly.showImage('imageViewHere', {url:'http://web.ipac.caltech.edu/staff/roby/demo/wise-m51-band2.fits', plotId: 'regiontest'});

            firefly.showCoverage('coverageHere', {gridOn:true});

            var v1= firefly.makeImageViewer('old1');
            var v2= firefly.makeImageViewer('old2');
            v1.plot(req);
            v2.plotURL('http://web.ipac.caltech.edu/staff/roby/demo/wise-m51-band2.fits');


            //-----------------  TABLE DEMO ------------------------//
            tblReq1 = firefly.util.table.makeIrsaCatalogRequest('wise_allwise_p3as_psd', 'WISE', 'wise_allwise_p3as_psd',
                    {   position: '148.9;68.8;EQ_J2000',
                        SearchMethod: 'Cone',
                        radius: 300
                    });
            tblReq2 = firefly.util.table.makeIrsaCatalogRequest('another wise catalog', 'WISE', 'wise_allwise_p3as_psd',
                    {   position: '10.68479;41.26906;EQ_J2000',
                        SearchMethod: 'Cone',
                        radius: 300
                    });
            tblReq3 = firefly.util.table.makeFileRequest(null, 'http://web.ipac.caltech.edu/staff/roby/demo/WiseDemoTable.tbl',null,
                    { pageSize: 15,
                        META_INFO: {CENTER_COLUMN: 'crval1;crval2;EQJ2000'}
                    });

            firefly.showTable('tables-1', tblReq1);
            firefly.showTable('tables-1', tblReq3);
            firefly.showTable('tables-2', tblReq2, {removable: false, showUnits: true, showFilters: true});
            //-----------------  CHART DEMO ------------------------//
            //--- using QUERY_ID: 'upload' does not work getActiveTableId('upload') returns undefined ---//
            firefly.addXYPlot('xyPlot1', {tbl_id: tblReq2.tbl_id, xCol: 'ra', yCol: 'dec'});
            firefly.addXYPlot('xyPlot2', {tbl_id: tblReq2.tbl_id, xCol: 'w1mpro+w4mpro', yCol: 'w2mpro'});

            //-----< old table api ------//
            var tblParams = {
                source: 'http://web.ipac.caltech.edu/staff/roby/demo/WiseDemoTable.tbl',
                type: 'selectable',
                Title: 'old api: selectable table',
                pageSize: 50,
                rowHeight: 30,
                tableOptions: "show-filter=true,show-title=true,show-toolbar=true,show-options=true,show-paging=true,show-save=true"
            };
            firefly.showTable(tblParams, 'oldSelectable');
            var tblParams2 = {
                source: 'http://web.ipac.caltech.edu/staff/roby/demo/WiseDemoTable.tbl',
                Title: 'old api: basic table',
                pageSize: 1000,
                tableOptions: "show-toolbar=false"
            };
            firefly.showTable(tblParams2, 'oldBasic');
            //----- old table api >------//

            //-----< old xyplot api ------//
            //--- using QUERY_ID: 'oldSelectable' does not work getActiveTableId('upload') returns undefined ---//
            firefly.addXYPlot({QUERY_ID: 'oldSelectable'}, 'oldXyPlot1');
            //-----< old xyplot api ------//

            window.regionAry = [
                 /*
                'global color=green dashlist=8 3 width=1 font="helvetica 10 normal normal" select=1 highlite=1 dash=0 fixed=0 edit=1 move=1 delete=1 include=1 rotate=0 source=1',
                'J2000;point    202.41   47.262 # color=pink text="pt circle 1" point=circle',
                'box (100p, 70p, 20p, 20p, 0) #color=red text={Physical coordinate - 1}',
                'box (100i, 70i, 30i, 30i, 0) #color=orange text={Image coordinate -2}',
                'line(202.414796 47.281999 202.423758 47.247072) # color=orange width=10 select=0 text={line 2}',
                'text 30p 40p # color=pink text={text test 3} edit=0 highlite=0 font="BRAGGADOCIO 10 normal roman"',
                'text 202.437691 47.234228{more text testing 4} # color=purple move=0',
                'point    202.43    47.270 # point=x 15 color=green text="pt x 5" rotate=0',
                '#point    202.45    47.262 # color=red 10p text="pt boxcircle 6" delete=0 point=boxcircle 10',
                'boxcircle point    202.45    47.262 # color=red text="pt boxcircle 6" delete=0',
                'physical;circle   80 140  20       # color=red offsetx=25  offsety=2 width=5 edit=0 text="circle 7"',
                'annulus   13h30m16.41s +47d14m43.9s  30p 40p 50p       # color=green text="hello" include=0 text="annulus 8"',
                'physical;point 200 140 # color=yellow point=cross 20 text="pt cross 9" offsetx=10',
                'physical;point 13h29m52.73s, +47d11m40.9s # color=purple point=diamond 15 text="pt diamond 10"',
                '#circle(202.55556, 47.188286 , 20p)  # color=blue text="text 11"',
                'box(202.55556, 47.188286 ,20p,40p, 30p, 50p, 0)  # color=red width=5 text="boxann 11"',
                'box(202.52556,47.226286,0.0240,0.006,0)  # color=green width=5 text="box 11-2"',
                'image;box(100, 150, 50p, 20p, 2r) # color=magenta width=6 text="slanted box 12"',
                'image;box(190.564796, 47.281999, 50p, 20p, 0) # color=red width=6 offsety=-15 text="box 12-1"',
                'j2000;box(47.247072i, 180.445347i, 50p, 20p, 0) # color=blue width=6 text="box 12-3"',
                'physical;-box point 12 12 # text="pt box 13"',
                'j2000;polygon(202.564796, 47.281999,202.553758, 47.247072, 202.445347, 47.244296, 202.479687, 47.264027, 202.492153, 47.290841) # color=blue text="polygon 14" offsety=10 width=10 font="helvetica 16 bold"',
                'point    202.45   47.2879 # color=cyan text="pt arrow 15" delete=0 point=arrow 20',
                'IMAGE;box (160, 70, 20, 20, 0) #color=red text={IMAGE test - 1}',
                'PHYSICAL;box (160, 70, 30, 30, 0) #color=orange text={PHYSICAL test -2}'
                */
                'box (240, 220, 20, 20, 0) #color=red text={     ph1}',
                'box (240i, 220i, 60i, 60i, 0) #color=orange text={ph2}',
                'J2000;point    202.41   47.262 # color=pink text="pt circle 1" point=circle',
                'IMAGE;box (360, 220, 20, 20, 0) #color=red text={     im1}',
                'PHYSICAL;box (360, 220, 60, 60, 0) #color=orange text={ph3}'
            ];

            window.regionAry2 = [
                'J2000',
                'boxcircle point    202.45    47.262 # color=red text="pt boxcircle 6" delete=0',
                'physical;circle   80 140  20       # color=red offsetx=25  offsety=2 width=5 edit=0 text="circle 7"',
                'annulus   13h30m16.41s +47d14m43.9s  30p 40p 50p       # color=green text="hello" include=0 text="annulus 8"',
                'physical;point 200 140 # color=yellow point=cross 20 text="pt cross 9" offsetx=10',
                'physical;point 13h29m52.73s, +47d11m40.9s # color=purple point=diamond 15 text="pt diamond 10"',
                '#circle(202.55556, 47.188286 , 20p)  # color=blue text="text 11"',
                'box(202.55556, 47.188286 ,20p,40p, 30p, 50p, 0)  # color=red width=5 text="boxann 11"',
                'box(202.52556,47.226286,0.0240,0.006,0)  # color=green width=5 text="box 11-2"',
                'image;box(100, 150, 50p, 20p, 2r) # color=magenta width=6 text="slanted box 12"',
                'image;box(190.564796, 47.281999, 50p, 20p, 0) # color=red width=6 offsety=-15 text="box 12-1"',
                'j2000;box(47.247072i, 180.445347i, 50p, 20p, 0) # color=blue width=6 text="box 12-3"',
                'physical;-box point 12 12 # text="pt box 13"',
                'j2000;polygon(202.564796, 47.281999,202.553758, 47.247072, 202.445347, 47.244296, 202.479687, 47.264027, 202.492153, 47.290841) # color=blue text="polygon 14" offsety=10 width=10 font="helvetica 16 bold"',
                'point    202.45   47.2879 # color=cyan text="pt arrow 15" delete=0 point=arrow 20',
            ];

            window.regionWithError = [
                'image; box 280 200 72 72 # color=blue text={wrong syntax}',
                'image; box 280 200 72 72 0 # color=cyan text={right syntax}'
            ];

            var moreRegionAry =  [
                'image;ellipse 100 100 20p 40p 30p 60p 40p 80p 20 # color=green text={ellipseannulus 2}',
                'J2000;ellipse 202.55556, 47.188286 20p 40p 0i # color=#48f text={ellipse 1} width=10',
                'image;box 130 100 20p 40p 30p 50p 70p 100p 30 # color=red text={slanted box annulus 3}'
            ];

            window.regions = [];
            window.regionId = window.regions.length;

            document.getElementById('regionLayerContent').value = window.regionAry.join('\n');
            document.getElementById('moreRegionContent').value = moreRegionAry.join('\n');
            //document.getElementById('createRegionId').placeholder = "Region_Plot_" + (window.regionId+1);
            updateRegionLayerList();
        };

        createRegionLayer = function() {
            var layerId = document.getElementById('createRegionId').value;

            if (!layerId) {
                window.regionId++;
                layerId = "Region_Plot_" + window.regionId;
                document.getElementById('createRegionId').value = layerId;
            }

            if (window.regionId === 3) {
                document.getElementById('regionLayerContent').value = window.regionWithError.join('\n');
            } else if (window.regionId > 1) {
                document.getElementById('regionLayerContent').value = window.regionAry2.join('\n');
            } else {
                document.getElementById('regionLayerContent').value = window.regionAry.join('\n');
            }

            var regionAry = document.getElementById('regionLayerContent').value.split('\n').filter(function(r) { return (r.length !== 0);});
            window.regions.push(layerId);
            updateRegionLayerList();

            firefly.action.dispatchCreateRegionLayer(layerId, layerId, null, regionAry, 'regiontest');
            firefly.action.dispatchCreateRegionLayer(layerId, layerId, null, regionAry, null, window.ffViewer.dispatch);
        };

        updateDataList = function() {
            var datalist = document.getElementById('regionCreated');
            var options = '';

            window.regions.forEach( function(r) {
                options += '<option value="'+r+'" />';
            });

            datalist.innerHTML = options;
            document.getElementById('createRegionId').value = '';
            document.getElementById('createRegionId').placeholder = "Region_Plot_" + (window.regionId+1);
        };

        updateRegionLayerList = function() {
            var selectListIds = ['regionList_delete', 'regionEntry_add', 'regionEntry_remove'];

            selectListIds.forEach( function(selectId) {
                var selectBox = document.getElementById(selectId);

                for (var i = selectBox.options.length - 1; i > 0; i--) {
                     selectBox.remove(i);
                }
                window.regions.forEach(function (r) {
                    var option = document.createElement('option');
                    option.value = r;
                    option.text = r;
                    selectBox.appendChild(option);
                });

                selectBox.getElementsByTagName('option')[0].selected = 'selected';
            });

            updateDataList();
        };

        deleteRegionLayer = function() {
            var selectBox = document.getElementById('regionList_delete');

            if (selectBox.selectedIndex !== 0) {
                var selectedLayerId = selectBox.options[selectBox.selectedIndex].value;

                window.regions.splice(selectBox.selectedIndex - 1, 1);
                updateRegionLayerList();

                firefly.action.dispatchDeleteRegionLayer(selectedLayerId, 'regiontest');
                firefly.action.dispatchDeleteRegionLayer(selectedLayerId, null, window.ffViewer.dispatch);
            }
        };

        addRegionEntry = function() {
            var selectBox=document.getElementById('regionEntry_add');
            var selectedLayerId = selectBox.options[selectBox.selectedIndex].value;
            var addRegions = document.getElementById('moreRegionContent').value.split('\n').filter(function(r) { return (r.length !== 0);});

            selectBox.getElementsByTagName('option')[0].selected = 'selected';

            firefly.action.dispatchAddRegionEntry(selectedLayerId, addRegions);
            firefly.action.dispatchAddRegionEntry(selectedLayerId, addRegions, window.ffViewer.dispatch);
        };

        removeRegionEntry = function() {
            var selectBox=document.getElementById('regionEntry_remove');
            var selectedLayerId = selectBox.options[selectBox.selectedIndex].value;
            var removeRegions = document.getElementById('moreRegionContent').value.split('\n').filter(function(r) { return (r.length !== 0);});

            selectBox.getElementsByTagName('option')[0].selected = 'selected';
            firefly.action.dispatchRemoveRegionEntry(selectedLayerId, removeRegions);
            firefly.action.dispatchRemoveRegionEntry(selectedLayerId, removeRegions, window.ffViewer.dispatch);
        };

        plotRemote= function() {
            firefly.getViewer().showImage({plotId: 'xxq',
                Service: 'TWOMASS',
                Title  : '2mass from service',
                SurveyKey  : 'k',
                WorldPt    : '10.68479;41.26906;EQ_J2000',
                RangeValues : firefly.util.image.serializeSimpleRangeValues("Sigma",-1,2,"Linear"),
                SizeInDeg  : '.12'
            })
        }
   }
   
</script>


<script  type="text/javascript" src="../firefly_loader.js"></script>


